<!-- docs/index.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantum Radar</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #121723;
      --muted: #9aa4b2;
      --text: #e6edf3;
      --green: #00c566;
      --yellow: #ffcc00;
      --red: #ff4d4f;
      --border: #202635;
      --chip: #1a2130;
      --accent: #3b82f6;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    h1 { margin: 0; font-size: 28px; }
    .muted { color: var(--muted); }
    .grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }
    .card {
      grid-column: span 12;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }
    @media (min-width: 900px) {
      .card { grid-column: span 6; }
    }
    .row { display: grid; grid-template-columns: 1.4fr 1.4fr 1fr; gap: 16px; }
    .box {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      height: 220px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .title { font-weight: 700; }
    .price { font-size: 26px; font-weight: 700; }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0f1522; padding: 6px 10px; border: 1px solid var(--border);
      border-radius: 999px; color: var(--muted); font-size: 13px;
    }
    .light { width: 12px; height: 12px; border-radius: 999px; display: inline-block; }
    .light.green { background: var(--green); box-shadow: 0 0 12px rgba(0,197,102,.5); }
    .light.yellow{ background: var(--yellow); box-shadow: 0 0 12px rgba(255,204,0,.5); }
    .light.red   { background: var(--red); box-shadow: 0 0 12px rgba(255,77,79,.5); }
    .sub { color: var(--muted); font-size: 13px; }
    .gauge {
      height: 10px; background: #0d1422; border: 1px solid var(--border); border-radius: 999px; overflow: hidden;
    }
    .gauge > div {
      height: 100%; background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
      width: 50%;
    }
    .pair { display: flex; align-items: center; justify-content: space-between; }
    .pill { background: #0d1524; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; font-size: 12px; }
    .section { margin-top: 24px; }
    a { color: var(--accent); text-decoration: none; }
    canvas { width: 100% !important; height: 140px !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Quantum Radar</h1>
      <div class="muted" id="meta"></div>
    </header>

    <div class="section">
      <div class="grid" id="cards"></div>
    </div>

    <div class="section">
      <h3>Varsler</h3>
      <div id="alerts" class="muted"></div>
    </div>
  </div>

  <script>
    const BUY_ZONES = {
      RGTI: [52.00, 50.00, 49.20, 47.80],
      QBTS: [38.00, 36.00, 34.50],
      IONQ: [],
      QUBT: [],
    };
    const NEAR_BAND = 0.005; // 0.5%

    // Kjøp/Hold/Selg-logikk (enkel, men effektiv)
    function decideSignal(tkr, price, changePct, trend) {
      if (!price || !trend) return {label: "HOLD", color: "yellow", reason: "mangler data"};
      const rsi = trend.rsi ?? 50;
      const ema20 = trend.ema20 ?? price;
      const status = trend.status || "WATCH";
      const dist20 = (price - ema20) / ema20;

      // Nær definert kjøpssone?
      const levels = BUY_ZONES[tkr] || [];
      const nearBuy = levels.some(lvl => Math.abs(price - lvl)/lvl <= NEAR_BAND);

      if (status === "DOWN" && rsi < 40 && nearBuy) {
        return {label:"BUY", color:"green", reason:"DOWN men nær dyp kjøpssone (contrarian)"};
      }
      if (status === "UP" && rsi >= 45 && rsi <= 65 && Math.abs(dist20) < 0.06) {
        return {label:"BUY", color:"green", reason:"UP + RSI 45–65 + nær EMA20"};
      }
      if (rsi > 75 || dist20 > 0.15 || (changePct && changePct > 12)) {
        return {label:"SELL", color:"red", reason:"overkjøpt / langt over EMA / stor spike"};
      }
      if (status === "DOWN" && rsi < 45 && dist20 < -0.05) {
        return {label:"HOLD", color:"yellow", reason:"nedsyklus – vent på bedre entry"};
      }
      return {label:"HOLD", color:"yellow", reason:"midt i range / avvent bekreftelse"};
    }

    // Fear/Greed 0..1 basert på RSI + avstand til EMA20
    function fearGreed(price, trend) {
      if (!trend || !price) return 0.5;
      const rsi = Math.max(0, Math.min(100, trend.rsi ?? 50));
      const ema20 = trend.ema20 ?? price;
      const dist = Math.max(-0.2, Math.min(0.2, (price - ema20) / ema20)); // clamp ±20%
      const rsiScore = rsi / 100;               // 0..1
      const distScore = (dist + 0.2) / 0.4;     // map -0.2..0.2 -> 0..1
      return Math.max(0, Math.min(1, 0.6*rsiScore + 0.4*distScore));
    }

    async function loadJSON(url) {
      const r = await fetch(url, {cache: "no-store"});
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function fmtPct(x) { return (x>=0?"+":"") + (x??0).toFixed(2) + "%"; }
    function fmtUSD(x) { return (x??0).toFixed(2); }

    function renderCard(root, p, t) {
      const price = p.price, chg = p.change_pct;
      const trend = t || {};
      const sig = decideSignal(p.ticker, price, chg, trend);
      const fg = fearGreed(price, trend);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="pair" style="margin-bottom:10px">
          <div class="title" style="font-size:18px">${p.ticker}</div>
          <div class="pill">RSI: ${trend.rsi?.toFixed?.(0) ?? "–"} | Trend: ${trend.status ?? "?"}</div>
        </div>
        <div class="row">
          <div class="box">
            <div class="pair"><div class="sub">Nåværende kurs</div><span class="chip"><span class="light ${sig.color}"></span>${sig.label}</span></div>
            <div class="price">$ ${fmtUSD(price)}</div>
            <div class="sub">${fmtPct(chg)} i dag • ${sig.reason}</div>
            <div style="margin-top:auto">
              <div class="pair" style="margin-bottom:6px">
                <div class="sub">Fear ↔ Greed</div>
                <div class="sub">${Math.round(fg*100)}</div>
              </div>
              <div class="gauge"><div style="width:${Math.round(fg*100)}%"></div></div>
            </div>
          </div>

          <div class="box">
            <div class="sub">Kursgraf (daglige closes)</div>
            <canvas id="chart_${p.ticker}"></canvas>
          </div>

          <div class="box">
            <div class="sub">Kjøpssoner</div>
            <div class="muted" style="line-height:1.7">
              ${
                (BUY_ZONES[p.ticker]||[]).length
                  ? BUY_ZONES[p.ticker].map(v=>`• ${p.ticker} @ $${v.toFixed(2)} ± ${(NEAR_BAND*100).toFixed(1)}%`).join("<br>")
                  : "Ingen definerte – bruker RSI/EMA-regler."
              }
            </div>
            <div style="margin-top:auto" class="sub">
              EMA20: $${trend.ema20?.toFixed?.(2) ?? "–"}<br>
              EMA5: $${trend.ema5?.toFixed?.(2) ?? "–"}
            </div>
          </div>
        </div>
      `;
      root.appendChild(card);

      // sparkline chart
      const ctx = card.querySelector(`#chart_${p.ticker}`);
      const hist = (p.history || []).slice(-30);
      const labels = hist.map(h => h.date);
      const data = hist.map(h => h.close);
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.25
          }]
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { display: false },
            y: { display: true, ticks: { color: "#6b7280" }, grid: { color: "#1f2937" } }
          }
        }
      });
    }

    async function main() {
      const data = await loadJSON("../data/data.json?_=" + Date.now());
      const meta = document.getElementById("meta");
      meta.textContent = `Sist oppdatert: ${data.generated_at} • Tickers: ${data.tickers.join(", ")}`;

      const priceMap = Object.fromEntries((data.prices||[]).map(p => [p.ticker, p]));
      const trendMap = Object.fromEntries((data.trend||[]).map(t => [t.ticker, t]));

      const root = document.getElementById("cards");
      (data.tickers || []).forEach(tkr => {
        const p = priceMap[tkr] || {ticker: tkr};
        const t = trendMap[tkr] || {};
        renderCard(root, p, t);
      });

      // En enkel “Varsler”-feed fra dagens nye signaler
      const alerts = document.getElementById("alerts");
      const todayCount = data.counts?.signals_today ?? 0;
      alerts.innerHTML = todayCount
        ? `Nye signaler i dag: <strong>${todayCount}</strong> • Sjekk Discord for DM-varsler.`
        : `Ingen nye signaler registrert i dag.`;
    }
    main().catch(e => {
      console.error(e);
      document.getElementById("cards").innerHTML =
        `<div class="muted">Klarte ikke laste data: ${String(e)}</div>`;
    });
  </script>
</body>
</html>
